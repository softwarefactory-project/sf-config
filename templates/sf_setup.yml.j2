---
# This file is managed by ansible, don't edit
# This playbook applies ansible roles.

- hosts: localhost
  connection: local
  tasks:
    - include: "{{'{{'}} sf_tasks_dir {{'}}'}}/ssh_populate_known_hosts.yml"

# Setup install-server ssh keys
- hosts: localhost
  connection: local
  roles:
    - name: "sf-ssh"
      action: "setup"

# Setup sf-base role on all hosts
- hosts: all
  roles:
    - name: "sf-postfix"
      action: "setup"
    - name: "sf-base"
      action: "setup"
    - name: "sf-monit"
      action: "setup"
{% if 'influxdb' in roles %}
    - name: "sf-telegraf"
      action: "setup"
{% endif %}

# Setup sf-mysql role before all components
- hosts: mysql
  roles:
    - name: "sf-mysql"
      action: "setup"

# Setup lecm if needed
- hosts: gateway
  roles:
    - name: "sf-lecm"
      action: "setup"
      when: "network.use_letsencrypt"

# Setup all components
{% for host in inventory %}
- hosts: {{ host['hostname'] }}
  vars:
    host_public_url: {{ host["public_url"] }}
  roles:
{% for role in host['rolesname'] %}{% if role != 'sf-mysql' %}
    - name: "{{ role }}"
      action: "setup"
{% for key, value in host['params'].items() %}
      {{ key }}: {{ value }}
{% endfor %}
{% endif %}{% endfor %}

{% endfor %}

- hosts: managesf
  gather_facts: no
  tasks:
    - include: "{{'{{'}} sf_tasks_dir {{'}}'}}/create_config-repo.yml"
{% if 'zuul3' in roles %}
    - include: "{{'{{'}} sf_tasks_dir {{'}}'}}/create_zuul-jobs.yml"
    - include: "{{'{{'}} sf_tasks_dir {{'}}'}}/update_zuul-jobs.yml"
{% endif %}

# Store deployed version to be used by upgrade playbook
- hosts: localhost
  connection: local
  tasks:
    - name: "Write current version"
      copy:
        dest: "/var/lib/software-factory/.version"
        content: "{{ sf_version }}"
