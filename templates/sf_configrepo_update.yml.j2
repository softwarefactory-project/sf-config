---
# This playbook reconfigure service based on config repo.
#

# Check config repo HEAD and update /root/config copy for each services
- hosts: localhost
  tasks:
    - name: Get config sha1
      command: git ls-remote -h http://{{ '{{' }} fqdn {{ '}}' }}/r/config.git
      register: configsha

- hosts: all
  tasks:
    - include: "{{'{{'}} sf_tasks_dir {{'}}'}}/update_configrepo.yaml"

- hosts: jenkins
  roles:
    - role: 'sf-jenkins'
      action: 'update'

{% if 'pages' in roles %}
- hosts: pages
  roles:
    - role: 'sf-pages'
      action: 'update'
{% endif %}

{% for host in inventory %}{% if 'sf-zuul' in host['rolesname'] %}
- hosts: {{ host['hostname'] }}
  roles:
    - role: 'sf-zuul'
      action: 'update'
{% for key, value in host['params'].items() %}
      {{ key }}: {{ value }}
{% endfor %}

{% endif %}{% endfor %}
{% if 'gerritbot' in roles %}
- hosts: gerritbot
  roles:
    - role: 'sf-gerritbot'
      action: 'update'

{% endif %}
{% for host in inventory %}{% if 'sf-nodepool' in host['rolesname'] %}
- hosts: {{ host['hostname'] }}
  roles:
    - role: 'sf-nodepool'
      action: 'update'
{% for key, value in host['params'].items() %}
      {{ key }}: {{ value }}
{% endfor %}

{% endif %}{% endfor %}
- hosts: gerrit
  tasks:
    # TODO: move this task to a replication role update action
    - include: "{{'{{'}} sf_tasks_dir {{'}}'}}/gerrit_replication_update.yaml"
  roles:
    - role: 'sf-gerrit'
      action: 'update'

{% for host in inventory %}{% if 'sf-zuul3' in host['rolesname'] %}
- hosts: {{ host['hostname'] }}
  roles:
    - role: 'sf-zuul3'
      action: 'update'
      zuul3_services: {{ host["params"]["zuul3_services"] }}

{% endif %}{% endfor %}
{% for host in inventory %}{% if 'sf-nodepool3' in host['rolesname'] %}
- hosts: {{ host['hostname'] }}
  roles:
    - role: 'sf-nodepool3'
      action: 'update'
      nodepool3_services: {{ host["params"]["nodepool3_services"] }}

{% endif %}{% endfor %}
- hosts: managesf
  roles:
    - role: 'sf-managesf'
      action: 'update'

{% if 'mirror' in roles %}
- hosts: mirror
  roles:
    - role: 'sf-mirror'
      action: 'update'

{% endif %}
{% if 'repoxplorer' in roles %}
- hosts: repoxplorer
  roles:
    - role: 'sf-repoxplorer'
      action: 'update'
{% endif %}

- hosts: gateway
  roles:
    - role: 'sf-gateway'
      action: 'update'
