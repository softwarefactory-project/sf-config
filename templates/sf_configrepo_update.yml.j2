---
# This playbook reconfigure service based on config repo.
#

# Check config repo HEAD and update /root/config copy for each services
- hosts: localhost
  tasks:
    - name: Get config sha1
      command: git ls-remote -h http://{{ '{{' }} fqdn {{ '}}' }}/r/config.git
      register: configsha

- hosts: all
  tasks:
    - include: "{{'{{'}} sf_tasks_dir {{'}}'}}/update_configrepo.yaml"

- hosts: jenkins
  roles:
    - role: 'sf-jenkins'
      action: 'update'

{% for host in inventory %}{% if 'sf-zuul' in host['rolesname'] %}
- hosts: {{ host['hostname'] }}
  roles:
    - role: 'sf-zuul'
      action: 'update'
{% for key, value in host['params'].items() %}
      {{ key }}: {{ value }}
{% endfor %}

{% endif %}{% endfor %}
{% if 'gerritbot' in roles %}
- hosts: gerritbot
  roles:
    - role: 'sf-gerritbot'
      action: 'update'

{% endif %}
{% for host in inventory %}{% if 'sf-nodepool' in host['rolesname'] %}
- hosts: {{ host['hostname'] }}
  roles:
    - role: 'sf-nodepool'
      action: 'update'
{% for key, value in host['params'].items() %}
      {{ key }}: {{ value }}
{% endfor %}

{% endif %}{% endfor %}
- hosts: gerrit
  tasks:
    # TODO: move this task to a replication role update action
    - include: "{{'{{'}} sf_tasks_dir {{'}}'}}/gerrit_replication_update.yaml"
  roles:
    - role: 'sf-gerrit'
      action: 'update'

- hosts: managesf
  roles:
    - role: 'sf-managesf'
      action: 'update'

{% if 'mirror' in roles %}
- hosts: mirror
  roles:
    - role: 'sf-mirror'
      action: 'update'

{% endif %}
{% if 'repoxplorer' in roles %}
- hosts: repoxplorer
  roles:
    - role: 'sf-repoxplorer'
      action: 'update'
{% endif %}

- hosts: gateway
  roles:
    - role: 'sf-gateway'
      action: 'update'

{% if 'pages' in roles %}
- hosts: mirror
  roles:
    - role: 'sf-pages'
      action: 'update'
  tasks:
    - name: Check modified witness
      stat:
        path: /var/lib/pagesuser/modified
      register: modified
- hosts: gateway
  tasks:
    - name: Reload httpd 
      systemd:
        name: httpd
        state: reloaded
      when: modified.stat.exists
- hosts: managesf.sftests.com
  tasks:
    - name: Prepare directory for merge op
      file:
        path: /var/lib/software-factory/temp/zuul-merge
        state: directory
    - name: Copy layout.yaml and pages.yaml for merging
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        remote_src: true
      with_items:
      - { src: '/etc/zuul/layout.yaml', dest: '/var/lib/software-factory/temp/zuul-merge/layout.yaml' }
      - { src: '/etc/zuul/pages.yaml', dest: '/var/lib/software-factory/temp/zuul-merge/pages.yaml' }
    - name: Compute layout
      command: bash -c "/usr/local/bin/yaml-merger.py /var/lib/software-factory/temp/zuul-merge  | tee /var/lib/software-factory/temp/zuul-merge/merged.yaml"
    - name: Copy merged layout.yaml 
      copy:
        src: /var/lib/software-factory/temp/zuul-merge/merged.yaml
        dest: /etc/zuul/layout.yaml
        remote_src: true
      register: layout
    - name: Reload zuul-server 
      systemd:
        name: zuul-server
        state: reloaded
      when: layout|changed

{% endif %}
