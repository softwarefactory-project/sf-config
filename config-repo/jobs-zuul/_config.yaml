# Config repository associated jobs
- job:
    name: 'config-check'
    builders:
      - shell: |
          set -e
          rm -Rf config build
          zuul-cloner http://gerrit/r config
          # Prepare a default configuration for zuul and nodepool
          mkdir -p build/nodepool build/zuul build/repoxplorer
          cp ~zuul/defconf/zuul.conf build/zuul/zuul.conf
          cp ~zuul/defconf/nodepool.yaml build/nodepool/_nodepool.yaml
          cp ~zuul/defconf/repoxplorer.py build/repoxplorer/config.py

          cd config
          echo "[+] Checking jobs"
          jenkins-jobs test jobs/ -o ../build/

          echo "[+] Checking zuul"
          /usr/share/sf-config/scripts/yaml-merger.py zuul | tee ../build/zuul/layout.yaml
          cp zuul/*.py ../build/zuul/ || true
          zuul-server -c ../build/zuul/zuul.conf -l ../build/zuul/layout.yaml -t

          echo "[+] Checking nodepool"
          /usr/share/sf-config/scripts/sf-nodepool-conf-merger.py ../build/nodepool/nodepool.yaml
          nodepool -c ../build/nodepool/nodepool.yaml config-validate

          echo "[+] Checking gerrit replication"
          git config -f gerrit/replication.config -l > /dev/null

          echo "[+] Checking gerrit commentlinks"
          python -c "import yaml; 'commentlinks' in yaml.safe_load(open('gerrit/commentlinks.yaml'))"

          echo "[+] Check dashboards"
          sf-update-dashboard --check --input dashboards/

          echo "[+] Checking syntax errors in policy file"
          python -c "import yaml; yaml.safe_load(open('policies/policy.yaml'))"

          echo "[+] Checking syntax errors in repoxplorer definition files"
          cat << EOF > config.py
          db_path = 'repoxplorer/'
          EOF
          repoxplorer-config-validate --config ../build/repoxplorer/config.py

          echo "[+] Checking resources changes"
          /usr/local/bin/resources.sh validate
    publishers:
      - console-log
    node: master

- job:
    name: 'config-update'
    builders:
      - shell: |
          set -e
          echo "[+] Updating configuration using $ZUUL_COMMIT"
          ssh root@install-server sf_configrepo_update

          echo "[+] Applying resources changes"
          /usr/local/bin/resources.sh apply
    publishers:
      - console-log
      - email-admin
    node: master
