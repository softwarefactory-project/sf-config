---
- name: Install requirements
  yum:
    name:
      - java-1.8.0-openjdk
      - elasticsearch-curator
    state: present
    disablerepo: "{{ yum_disable_repo|default(omit) }}"
    enablerepo: "{{ yum_enable_repo|default(omit) }}"

- include_tasks: configure_mirror.yml

- name: Install Elasticsearch package
  yum:
    name: "elasticsearch-{{ elk_stack_version }}.{{ elk_sub_version }}.0-1"
    state: present
    disablerepo: "*"
    enablerepo: "{{ elastic_repo_name }}"
    allow_downgrade: true

# NOTE: Seems that allow_downgrade does not work as expected in
# current Ansible version. The ELK stack packages are made in RPM tool,
# where there is not set conflict for previous version and also new
# package version is providing all other versions back (tested on 7.8.1-1,
# 7.7.0-1, 7.6.0-1). In that case, run downgrade command manually.
- name: Run downgrade command manually
  command: |
    yum downgrade -y "elasticsearch-{{ elk_stack_version }}.{{ elk_sub_version }}.1-1"
