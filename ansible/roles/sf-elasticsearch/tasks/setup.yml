---
- include_tasks: "{{ sf_tasks_dir }}/check_version.yml"

- name: Create elasticsearch group
  group:
    name: elasticsearch

- name: Create elasticsearch user
  user:
    name: elasticsearch
    group: elasticsearch
    shell: /sbin/nologin
    home: /var/lib/elasticsearch

- name: Ensure /var/lib/elasticsearch directory exists
  file:
    path: /var/lib/elasticsearch
    state: directory
    mode: 0700
    owner: elasticsearch
    group: elasticsearch

- name: Ensure /var/run/elasticsearch directory exists
  file:
    path: /var/run/elasticsearch
    state: directory
    mode: 0755
    owner: elasticsearch
    group: elasticsearch

- name: Ensure Elasticsearch listen to all addresses
  lineinfile:
    dest: /etc/elasticsearch/elasticsearch.yml
    regexp: "^network.host{{':'}}.*"
    insertafter: "^# network.host:"
    line: "network.host{{':'}} elasticsearch.{{ fqdn }}"
  register: listenaddr

# TODO: find a solution to set the replica or elasticsearch won't start:
#
# Found index level settings on node level configuration.
#
# Since elasticsearch 5.x index level settings can NOT be set on the nodes
# configuration like the elasticsearch.yaml, in system properties or command line
# arguments.In order to upgrade all indices the settings must be updated via the
# /${index}/_settings API. Unless all settings are dynamic all indices must be closed
# in order to apply the upgradeIndices created in the future should use index templates
# to set default values.
#
# Please ensure all required values are updated on all indices by executing:
#
# curl -XPUT 'http://localhost:9200/_all/_settings?preserve_existing=true' -d '{
#   "index.number_of_replicas" : "0"
# }'

#- name: Set Elasticsearch indexes replica count
#  lineinfile:
#    dest: /etc/elasticsearch/elasticsearch.yml
#    regexp: "^index.number_of_replicas{{':'}}.*$"
#    line: "index.number_of_replicas{{':'}} {{ elasticsearch_replicas }}"
#  register: replicas

- name: Set Eleasticsearch JAVA HEAP Size
  lineinfile:
    dest: /etc/sysconfig/elasticsearch
    regexp: "^.*ES_HEAP_SIZE=.*$"
    line: "ES_HEAP_SIZE={{ elasticsearch_heap_size }}"
  register: heapsize

- name: Restart elasticsearch if needed
  service:
    name: elasticsearch
    state: restarted
  when: listenaddr is changed or heapsize is changed
# when: listenaddr is changed or heapsize is changed or replicas is changed

- name: Start service
  systemd:
    name: elasticsearch
    state: started
    daemon_reload: "yes"
    enabled: "yes"
