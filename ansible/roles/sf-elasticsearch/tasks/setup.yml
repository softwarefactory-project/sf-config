---
- include_tasks: "{{ sf_tasks_dir }}/check_version.yml"

- name: Create elasticsearch group
  group:
    name: elasticsearch

- name: Create elasticsearch user
  user:
    name: elasticsearch
    group: elasticsearch
    shell: /sbin/nologin
    home: /var/lib/elasticsearch

- name: Ensure /var/lib/elasticsearch directory exists
  file:
    path: /var/lib/elasticsearch
    state: directory
    mode: 0700
    owner: elasticsearch
    group: elasticsearch

- name: Ensure /var/run/elasticsearch directory exists
  file:
    path: /var/run/elasticsearch
    state: directory
    mode: 0755
    owner: elasticsearch
    group: elasticsearch

# network.url is deprecated, need to use server ip addr
# for network.host
- name: Configure Elasticsearch
  lineinfile:
    dest: '{{ item.dest }}'
    regexp: '^#?{{ item.regexp }}.*'
    line: '{{ item.line }}'
  with_items:
    - regexp: 'network.host'
      line: 'network.host:  {{ ansible_default_ipv4.address }}'
      dest: /etc/elasticsearch/elasticsearch.yml
    - regexp: '-Xms'
      line: '-Xms{{ elasticsearch_minimum_heap_size }}'
      dest: /etc/elasticsearch/jvm.options
    - regexp: '-Xmx'
      line: '-Xmx{{ elasticsearch_maximum_heap_size }}'
      dest: /etc/elasticsearch/jvm.options
  register: elasticsearchconf

- name: Restart elasticsearch if needed
  service:
    name: elasticsearch
    state: restarted
  when: elasticsearchconf is changed

- name: Start service
  systemd:

- name: Set default number of replicas
  uri:
    url: '{{ item.url }}'
    method: PUT
    body_format: json
    body: '{{ item.body }}'
    status_code: 200
  loop:
    - url: 'http://elasticsearch.{{ fqdn }}:9200/_template/template_1'
      body: '{
                "template" : "*",
                "settings" : {
                    "number_of_replicas" : {{ elasticsearch_replicas }}
                }
            }'
