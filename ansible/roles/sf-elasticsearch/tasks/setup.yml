---
- include_tasks: "{{ sf_tasks_dir }}/check_version.yml"
- include_tasks: "{{ sf_tasks_dir }}/create_user.yml user_name=elasticsearch"

- name: Configure Elasticsearch
  lineinfile:
    dest: '{{ item.dest }}'
    regexp: '^#?{{ item.regexp }}.*'
    line: '{{ item.line }}'
  with_items:
    - regexp: 'network.host'
      line: 'network.host:  {{ ansible_default_ipv4.address }}'
      dest: /etc/elasticsearch/elasticsearch.yml
    - regexp: '-Xms'
      line: '-Xms{{ elasticsearch_minimum_heap_size }}'
      dest: /etc/elasticsearch/jvm.options
    - regexp: '-Xmx'
      line: '-Xmx{{ elasticsearch_maximum_heap_size }}'
      dest: /etc/elasticsearch/jvm.options
  register: elasticsearchconf

- name: Restart elasticsearch if needed
  systemd:
    name: elasticsearch
    state: restarted
    daemon_reload: "yes"
  when: elasticsearchconf is changed

- name: Start service
  systemd:
    name: elasticsearch
    state: started
    daemon_reload: "yes"
    enabled: "yes"

- name: Wait for service
  wait_for:
    host: 'elasticsearch.{{ fqdn }}'
    port: 9200
    delay: 10
    timeout: 600

- name: Configure elasticsearch replicas
  uri:
    url: 'https://{{ fqdn }}/elasticsearch/_template/default_settings'
    method: PUT
    body_format: json
    body: '{
              "template" : "*",
              "settings" : {
                  "number_of_replicas" : {{ elasticsearch_replicas }}
              }
          }'
    status_code: 200

- name: Update replicas for existing indices
  uri:
    url: "http://{{ fqdn }}/elasticsearch/_settings?pretty"
    method: PUT
    body_format: json
    body: '{ "index":
             { "number_of_replicas": {{ elasticsearch_replicas }}
             }
           }'
    status_code: 200
