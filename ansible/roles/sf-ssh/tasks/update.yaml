---
- name: Check hostname in ssh public keys
  shell: 'grep -r -q  {{ fqdn }} /var/lib/software-factory/bootstrap-data/ssh_keys/*pub'
  args:
    warn: false
  ignore_errors: true
  register: check_pubkeys
  changed_when: false

- name: Update hostname in ssh public keys
  block:
    - name: Get all pubkeys filenames
      shell: ls /var/lib/software-factory/bootstrap-data/ssh_keys/*.pub
      register: pubkeys

    - name: Set hostname in pub keys files
      shell: 'sed -i "s/@.*/@{{ fqdn }}/" {{ item }}'
      args:
        warn: false
      with_items:
        - '{{ pubkeys.stdout_lines }}'
  when: check_pubkeys.rc != 0
