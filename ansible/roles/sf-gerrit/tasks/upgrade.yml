---
- name: Stop service
  service:
    name: gerrit
    state: stopped

- block:
    - name: Install migration package
      package:
        name: gerrit-migration

    - name: Create lib dir
      file:
        path: /var/lib/gerrit/lib/
        state: directory

    - name: Setup connector
      file:
        src: /usr/share/java/mysql-connector-java.jar
        dest: /var/lib/gerrit/lib/mysql-connector-java-5.1.48.jar
        state: link

    - name: Upgrade db
      command: /usr/bin/java -jar /var/lib/gerrit/migration.war init -d /var/lib/gerrit --batch --no-auto-start --skip-plugins
      become: true
      become_user: gerrit

    - name: Run notedb migration
      command: /usr/bin/java -jar /var/lib/gerrit/migration.war migrate-to-note-db -d /var/lib/gerrit
      become: true
      become_user: gerrit

    - name: Run notedb-tools script
      command: /usr/local/bin/notedb-tools.py --fqdn "{{ fqdn }}" migrate

  when: _previous_version.stdout.startswith('gerrit-2.')
