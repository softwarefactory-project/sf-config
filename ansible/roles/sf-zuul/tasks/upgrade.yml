---
- name: Remove legacy public key
  command: "find {{ zuul_lib_dir }}/keys/ -name \"*.pub\" -delete"
  when: _previous_version.stdout.startswith('rh-python35-zuul-3.2.0')

- name: Remove legacy public key bis
  file:
    path:
    state: absent
  with_items:
    - /var/lib/software-factory/state/config_key_checksum
    - "{{ zuul_lib_dir }}/config.pub"

- name: Check for legacy state
  stat:
    path: /var/opt/rh/rh-python35/lib/zuul/
  register: _zuul_scl

- name: Move state directory to system directory
  shell: |
    if test -L {{ item.dst }}; then
        rm {{ item.dst }}
        mkdir -m {{ item.mode|default('0700') }} {{ item.dst }}
        chown {{ item.owner|default('zuul') }}:{{ item.owner|default('zuul') }} {{ item.dst }}
    fi
    mv {{ item.src }}/* {{ item.src }}/.[a-zA-Z0-9]* {{ item.dst }}/
    rmdir {{ item.src }}
  with_items:
    - src: /var/opt/rh/rh-python35/lib/zuul
      dst: /var/lib/zuul
    - src: /var/opt/rh/rh-python35/log/zuul
      dst: /var/log/zuul
    - src: /etc/opt/rh/rh-python35/zuul
      dst: /etc/zuul
      owner: root
      mode: "0755"
  when: _zuul_scl.stat.exists
