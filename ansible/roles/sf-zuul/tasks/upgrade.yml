---
- block:
    - name: Remove /var/lib/zuul*
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /etc/zuul
        - /etc/zuul3
        - /var/lib/zuul
        - /var/lib/zuul3
        - /var/log/zuul
        - /var/log/zuul3
        - /usr/bin/zuul
        - /usr/bin/zuul3

    - name: Remove zuulv2
      yum:
        name: "zuul"
        state: absent

    - name: Check for zuul3 database
      command: mysql -e "show tables;" zuul3
      failed_when: false
      changed_when: false
      register: _zuul3_database
      delegate_to: localhost

    - name: Drop zuul2 database
      command: mysql -e "DROP DATABASE zuul;"
      failed_when: false
      changed_when: false
      when: _zuul3_database.rc == 0
      delegate_to: localhost

    - name: Create zuul database
      command: >
        mysql -e "CREATE DATABASE zuul CHARACTER SET utf8 COLLATE utf8_general_ci;"
              -e "GRANT ALL PRIVILEGES ON zuul.* TO 'zuul'@'localhost' IDENTIFIED BY '{{ zuul_mysql_password }}' WITH GRANT OPTION;"
              -e "GRANT ALL PRIVILEGES ON zuul.* TO 'zuul'@'{{ zuul_mysql_host }}' IDENTIFIED BY '{{ zuul_mysql_password }}' WITH GRANT OPTION;"
      when: _zuul3_database.rc == 0
      delegate_to: localhost

    - name: Move zuul3 tables in zuul db and drop zuul3 db
      command: >
        mysql -e "RENAME TABLE zuul3.zuul_build TO zuul.zuul_build;"
              -e "RENAME TABLE zuul3.zuul_buildset TO zuul.zuul_buildset;"
              -e "RENAME TABLE zuul3.alembic_version TO zuul.alembic_version;"
              -e "DROP DATABASE zuul3;"
      when: _zuul3_database.rc == 0
      delegate_to: localhost
  when: sf_previous_version < 3.0
