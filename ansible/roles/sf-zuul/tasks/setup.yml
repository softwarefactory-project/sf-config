---
# Use 0751 to let apache access /var/lib/zuul/git
# Use /bin/sh shell to allow zuul to connect to localhost for config-update jobs
- include: "{{ sf_tasks_dir }}/create_user.yml user_name=zuul ssh_key=jenkins_rsa home_dir_mode=0751 shell=/bin/sh"

- name: Authorize zuul localhost connection for config-update jobs
  authorized_key:
      user: zuul
      key: "{{ zuul_rsa_pub }}"

- name: Apply selinux port labelling
  seport:
      ports: "{{ zuul_port }}"
      proto: tcp
      setype: http_port_t
      state: present
  when: ansible_selinux.status == "enabled"

- name: Setup apache site zuul.conf
  template: src=zuul.site.j2 dest=/etc/httpd/conf.d/zuul.conf mode=0444
  notify: apache reload

- name: Create config-check directory
  file: path=/var/lib/zuul/defconf state=directory

- name: Install config-check service default configuration
  template:
    src: "config-check/{{ item }}.j2"
    dest: "/var/lib/zuul/defconf/{{ item|replace('defconf-', '') }}"
  with_items:
    - defconf-nodepool.yaml
    - defconf-zuul.conf
    - defconf-repoxplorer.py

- name: Create /var/www/zuul
  file: path=/var/www/zuul state=directory

- name: Create /var/www/logs/results
  file: path=/var/www/logs/results state=directory owner=zuul mode=0755

- name: Symlink zuul image
  file: src=/usr/share/javascript/zuul/images/ dest=/var/www/zuul/images state=link

- name: Symlink zuul static assets
  file: src=/usr/share/javascript/zuul/ dest=/var/www/static/zuul state=link

- name: Install index.html for zuul
  copy:
    src: zuul.index.html
    dest: /var/www/zuul/index.html
    mode: 0444

- name: "Copy logging configuration"
  template: src={{ item }}.j2 dest=/etc/zuul/{{ item }}
  with_items:
    - logging.conf
    - gearman-logging.conf
    - merger-logging.conf
    - launcher-logging.conf

- name: "Setup sysconfig"
  template: src=sysconfig.j2 dest=/etc/sysconfig/zuul
  notify: restart zuul if already started

- name: "Setup configuration"
  template: src=zuul.conf.j2 dest=/etc/zuul/zuul.conf mode=0440 group=zuul
  notify: restart zuul if already started

- name: "Copy gearman-check script"
  copy: src=gearman-check dest=/usr/local/bin/gearman-check mode=0555
  when: "'zuul' in zuul_services"

- name: "Setup gearman-check cron"
  cron: name=gearman-check-cron job=/usr/local/bin/gearman-check minute=0 hour=0
  when: "'zuul' in zuul_services"
