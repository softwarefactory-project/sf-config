---
- name: Install configuration templates
  template:
    src: '{{ item }}.j2'
    dest: '/etc/telegraf/telegraf.d/{{ item }}'
    owner: telegraf
    group: root
    mode: 0440
  with_items:
    - output_influxdb.conf
  notify: Restart telegraf

- name: Install configuration files
  copy:
    src: '{{ item }}'
    dest: '/etc/telegraf/telegraf.d/{{ item }}'
    owner: telegraf
    mode: 0440
  with_items:
    - inputs.conf
    - statsd.conf
  notify: Restart telegraf

- name: Configure hostname
  replace:
    dest: /etc/telegraf/telegraf.conf
    regexp: '  hostname = ""'
    replace: '  hostname = "{{ ansible_fqdn }}"'

- name: Start service
  service:
    name: telegraf
    state: started
    enabled: "yes"
