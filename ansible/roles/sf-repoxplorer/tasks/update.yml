---
- file:
    path: /var/lib/software-factory/state/repoxplorer_config
    state: touch

- name: Check local repoxplorer config
  command: cat /var/lib/software-factory/state/repoxplorer_config
  register: localconfig

- name: Check upstream repoxplorer config
  command: git log -n 3 --oneline repoxplorer/ resources/
  args:
    chdir: /root/config
  register: upstreamconfig

- name: Update repoXplorer configuration
  block:
    - name: Update local repoxplorer configuration files
      copy:
        src: "{{ item }}"
        dest: "/etc/repoxplorer/"
      with_fileglob:
        - "/root/config/repoxplorer/*"

    - name: Update repoXplorer default.yaml by calling managesf
      uri:
        url: "{{ managesf_internal_url }}/v2/configurations/repoxplorer"
        method: GET
        dest: "/etc/repoxplorer/default.yaml"
      when: localconfig.stdout != upstreamconfig.stdout

    - name: Write config repo sha1 matching current repoxplorer configuration
      copy:
        content: "{{ upstreamconfig.stdout }}"
        dest: /var/lib/software-factory/state/repoxplorer_config
  when: localconfig.stdout != upstreamconfig.stdout
