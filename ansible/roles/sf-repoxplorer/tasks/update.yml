---
- file:
    path: /var/lib/software-factory/state/repoxplorer_config
    state: touch

- name: "Check local repoxplorer config"
  command: cat /var/lib/software-factory/state/repoxplorer_config
  register: localconfig

- name: "Check upstream repoxplorer config"
  command: git log -n 3 --oneline repoxplorer/ resources/
  args:
    chdir: /root/config
  register: upstreamconfig

- name: "Update local repoxplorer configuration files"
  when: localconfig.stdout != upstreamconfig.stdout
  copy:
    src: "{{ item }}"
    dest: "/etc/repoxplorer/"
  with_fileglob:
    - "/root/config/repoxplorer/*"

- name: "Update default repoxplorer index file from SF resources"
  command: /usr/local/bin/resources2repoxplorer.py apply
  when: localconfig.stdout != upstreamconfig.stdout

- name: "Write config repo sha1 matching current repoxplorer configuration"
  copy:
    content: "{{ upstreamconfig.stdout }}"
    dest: /var/lib/software-factory/state/repoxplorer_config
  when: localconfig.stdout != upstreamconfig.stdout
