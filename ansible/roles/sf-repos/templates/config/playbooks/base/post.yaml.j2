---
- hosts: localhost
  tasks:
    - block:
        - import_role: name=log-classify
          when: logclassify_optin|default(False)
      vars:
        logclassify_model_store_url: https://{{ fqdn }}/logs/classifiers
        logclassify_zuul_web: https://{{ fqdn }}/zuul/api/tenant/{{ tenant_name }}
        logclassify_model_dir: /var/lib/log-classify
        logclassify_local_dir: "{{'{{'}} zuul.executor.log_root {{'}}'}}"

    - block:
        - import_role: name=add-fileserver
      vars:
        fileserver: "{{'{{'}} site_sflogs {{'}}'}}"

    - import_role: name=emit-ara-html

- hosts: "{{'{{'}} site_sflogs.fqdn {{'}}'}}"
  gather_facts: false
  tasks:
    # Use a block because play vars doesn't take precedence on roles vars
    - block:
        - import_role: name=upload-log-classify-model
        - import_role: name=upload-logs
        - import_role: name=emit-job-report
        - import_role: name=buildset-artifacts-location
      vars:
        zuul_log_url: "https://{{ fqdn }}/logs"
        zuul_logserver_root: /var/www/logs

{% if 'job-logs-gearman-client' in roles %}
- hosts: localhost
  ignore_errors: yes
  roles:
    - role: submit-logstash-jobs
      logstash_gearman_server: "job-logs-gearman-client.{{ fqdn }}"
      logstash_gearman_server_port: 4731
{% endif %}
