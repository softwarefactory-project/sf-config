---
- name: Ensure zuul-jobs exists
  file:
    path: /root/config/jobs-zuul
    state: directory

- name: Ensure nodpeoolV3 exists
  file:
    path: /root/config/nodepoolV3
    state: directory

- name: Ensure defaults files are updated (prefixed by '_')
  register: config_repo_status
  template:
    dest: /root/config/{{ item.dest }}
    src: '{{ item.src }}'
  with_items:
    - dest: jobs/_default_jobs.yaml
      src: config/jobs/_default_jobs.yaml.j2
    - dest: jobs-zuul/_macros.yaml
      src: config/jobs-zuul/_macros.yaml.j2
    - dest: jobs-zuul/_config.yaml
      src: /usr/share/sf-config/ansible/roles/sf-repos/files/config/jobs-zuul/_config.yaml
    - dest: zuul/_layout.yaml
      src: /usr/share/sf-config/ansible/roles/sf-repos/files/config/zuul/_layout.yaml
    - src: config/nodepoolV3/_local_hypervisor_oci.yaml.j2
      dest: nodepoolV3/_local_hypervisor_oci.yaml

- block:
    # does this need to register config_repo_status too?
    - name: Remove legacy zuulv3/main.yaml
      file:
        path: /root/config/zuulV3/main.yaml
        state: absent
  when: sf_previous_version < 2.7

- block:
    - name: submit policies updates
      register: config_repo_status
      blockinfile:
        path: /root/config/policies/policy.yaml
        marker: "# -- generic policies added with release 3.0 --"
        block: |
          # zuul API
          'zuul.tenants:get': 'rule:any'
          'zuul.tenant.status:get': 'rule:any'
          'zuul.tenant.jobs:get': 'rule:any'
          'zuul.tenant.builds:get': 'rule:any'
          'zuul.tenant.console-stream:get': 'rule:any'
          'zuul.status:get': 'rule:any'
          'zuul.status.change:get': 'rule:any'
          'zuul.project.public_keys:get': 'rule:any'
          # nodepool API
          'nodepool.image:list': 'rule:any'
          'nodepool.dib-image:list': 'rule:any'
          'nodepool.node:list': 'rule:any'
          'nodepool.label:list': 'rule:any'
          'nodepool.request:list': 'rule:any'
          'nodepool.node:hold': 'rule:admin_or_service'
          'nodepool.node:delete': 'rule:admin_or_service'

  when: sf_previous_version < 3.0

- name: Push config-repo updates
  command: chdir=/root/config {{ item }}
  with_items:
    - git add jobs-zuul/_macros.yaml jobs-zuul/_config.yaml nodepoolV3/_local_hypervisor_oci.yaml
    - git commit -a -m "Update default configuration (from {{ sf_previous_version }} to {{ sf_version }})"
    - git push git+ssh://gerrit/config master
  when: config_repo_status|changed
