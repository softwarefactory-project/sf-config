---
- set_fact:
    config_clone_dir: "/root/config"

- name: Sync config local copy
  command: "git {{ item }}"
  args:
    chdir: "{{ config_clone_dir }}"
  with_items:
    - "remote set-url origin git+ssh://gerrit/config"
    - "fetch --all"
    - "reset --hard origin/master --"
    - "clean -f -x -d"

- block:
    - name: Move nodepool elements/scripts
      command: "git mv nodepool/elements nodepool/scripts nodepoolV3/"
      args:
        chdir: "{{ config_clone_dir }}"

    - name: Ensure nodepool/zuul are deleted
      command: "git rm -r {{ item }}"
      with_items:
        - zuul
        - nodepool
      args:
        chdir: "{{ config_clone_dir }}"

    - name: Rename nodepool/zuul version
      command: "git mv {{ item }}V3 {{ item }}"
      with_items:
        - zuul
        - nodepool
      args:
        chdir: "{{ config_clone_dir }}"

    - name: Create symlinks to prevent breakage
      file:
        src: "{{ item }}"
        dest: "/root/config/{{ item }}V3"
        state: link
      with_items:
        - zuul
        - nodepool

    - name: Update nodepool elements names
      command: >
        sed -i -e 's/nodepool3-minimal/nodepool-minimal/'
               -e 's/sf-zuul-worker/zuul-worker-user/'
               -e 's/sf-zuul3-worker/zuul-worker-user/'
          {{ item }}
      with_fileglob: /root/config/nodepool/*

    - name: Push v2 configuration removal
      command: "git {{ item }}"
      args:
        chdir: "{{ config_clone_dir }}"
      with_items:
        - "add nodepool zuul"
        - "commit -m 'Delete Zuul/Nodepool V2 configuration'"
        - "push git+ssh://gerrit/config master"
  when: sf_previous_version < 3.0

- include_tasks: sync_config_repo_content.yml

- name: Push config change
  command: "git {{ item }}"
  args:
    chdir: "{{ config_clone_dir }}"
  with_items:
    - "add -A"
    - "commit -m 'Update Zuul V3 default definitions'"
    - "push git+ssh://gerrit/config master"
  when: config_repo_updated
