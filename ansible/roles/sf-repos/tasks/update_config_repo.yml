---
- set_fact:
    config_clone_dir: /root/config

- name: Sync config local copy
  command: "git {{ item }}"
  args:
    chdir: "{{ config_clone_dir }}"
  with_items:
    - "remote set-url origin {{ config_location }}"
    - "fetch --all"
    - "reset --hard origin/master --"
    - "clean -f -x -d"

- include_tasks: sync_config_repo_content.yml

- name: Check for changes
  command: git status -s
  args:
    chdir: "{{ config_clone_dir }}"
  register: config_repo_updated

- name: Push config change
  command: "git {{ item }}"
  args:
    chdir: "{{ config_clone_dir }}"
  with_items:
    - "add -A"
    - "commit -m 'Update default definitions'"
    - "push {{ config_location }} master"
  when: config_repo_updated.stdout
