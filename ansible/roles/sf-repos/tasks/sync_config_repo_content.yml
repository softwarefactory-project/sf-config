---
- stat:
    path: "{{ config_clone_dir }}/metrics"

- name: Add default metrics configuration directory
  synchronize:
    src: /usr/share/sf-config/ansible/roles/sf-repos/files/config/metrics/
    dest: "{{ config_clone_dir }}/metrics"
    archive: "no"
    times: "no"
    checksum: "yes"
    perms: "yes"
    recursive: "yes"
  register: _config_metrics_files

- name: Add default dlrn configuration directory
  synchronize:
    src: /usr/share/sf-config/ansible/roles/sf-repos/files/config/dlrn/
    dest: "{{ config_clone_dir }}/dlrn"
    archive: "no"
    times: "no"
    checksum: "yes"
    perms: "yes"
    recursive: "yes"
  register: _config_dlrn_files

- name: Ensure config sub dir
  file:
    path: "{{ config_clone_dir }}/{{ item }}"
    state: directory
  with_items:
    - resources
    - nodepool
    - zuul
    - zuul.d
    - playbooks/base

- name: Ensure retro-compatibility symlinks
  file:
    src: "{{ item }}"
    dest: "{{ config_clone_dir }}/{{ item }}V3"
    state: link
  with_items:
    - nodepool
    - zuul

- name: Sync config static files
  synchronize:
    src: "/usr/share/sf-config/ansible/roles/sf-repos/files/config/{{ item }}/"
    dest: "{{ config_clone_dir }}/{{ item }}/"
    archive: "no"
    times: "no"
    checksum: "yes"
    delete: "yes"
    perms: "yes"
    recursive: "yes"
    rsync_opts:
      - "--exclude=update.yaml"
  with_items:
    - playbooks/config
    - playbooks/pages
  register: _config_static_files

- name: Update config templates
  template:
    src: "config/{{ item }}.j2"
    dest: "{{ config_clone_dir }}/{{ item }}"
  with_items:
    - resources/_internal.yaml
    - playbooks/base/pre.yaml
    - playbooks/base/post.yaml
    - playbooks/config/update.yaml
    - zuul.d/_jobs-base.yaml
    - zuul.d/_jobs-pages.yaml
    - zuul.d/_pipelines.yaml
    - zuul/_main.yaml
    - nodepool/_local_hypervisor_oci.yaml
  register: _config_template_files

- name: Check for misplaced config.pub
  stat:
    path: /var/lib/software-factory/certs/config.pub
  register: _config_pub

- name: Fix config.pub cert path
  command: mv /var/lib/software-factory/certs/config.pub /var/lib/software-factory/bootstrap-data/certs/config.pub
  when: _config_pub.stat.exists

- name: Verify if config repository key changed
  block:
    - name: Check config repository key
      stat:
        path: /var/lib/software-factory/bootstrap-data/certs/config.pub
      register: _config_repo_key

    - name: Ensure config_key_checksum exists
      file:
        path: /var/lib/software-factory/state/config_key_checksum
        state: touch

    - name: Read last config_key_checksum
      command: cat /var/lib/software-factory/state/config_key_checksum
      changed_when: false
      register: localconfig

    - name: Set config_key_regenerated fact
      set_fact:
        new_config_key: "{{ config_key_exists and localconfig.stdout != _config_repo_key.stat.checksum|default(None) }}"

- block:
    - name: "Generate sflogs ssh_private_key secret"
      command: >
        /usr/share/sf-config/scripts/zuul-encrypt-secret.py \
            /var/lib/software-factory/bootstrap-data/certs/config.pub ssh_private_key \
            --infile /var/lib/software-factory/bootstrap-data/ssh_keys/zuul_logserver_rsa
      register: _sflogs_private_key_secret

    - name: Update secret_sflogs.yaml
      template:
        src: "config/zuul.d/_secret_sflogs.yaml.j2"
        dest: "{{ config_clone_dir }}/zuul.d/_secret_sflogs.yaml"
  when:
    - new_config_key
    - config_key_exists

- name: install server secret
  block:

    - name: "Generate install_server ssh_private_key secret"
      command: >
        /usr/share/sf-config/scripts/zuul-encrypt-secret.py \
            /var/lib/software-factory/bootstrap-data/certs/config.pub ssh_private_key \
            --infile /var/lib/software-factory/bootstrap-data/ssh_keys/zuul_worker_rsa
      register: _install_server_private_key_secret

    - name: Update secret_install_server.yaml
      template:
        src: "config/zuul.d/_secret_install_server.yaml.j2"
        dest: "{{ config_clone_dir }}/zuul.d/_secret_install_server.yaml"
  when:
    - new_config_key
    - config_key_exists

- name: install tenant update secret
  block:
    - name: Scan master_sf known hosts
      command: "ssh-keyscan -t rsa {{ master_sf_fqdn }}"
      register: _master_sf_known_hosts

    - name: Update secret_tenant_update.yaml
      template:
        src: "config/zuul.d/_secret_tenant_update.yaml.j2"
        dest: "{{ config_clone_dir }}/zuul.d/_secret_tenant_update.yaml"
  when:
    - tenant_deployment
    - new_config_key
    - config_key_exists

- block:
    - name: Generate sfpages ssh_private_key secret
      command: >
        /usr/share/sf-config/scripts/zuul-encrypt-secret.py \
            /var/lib/software-factory/bootstrap-data/certs/config.pub ssh_private_key \
            --infile /var/lib/software-factory/bootstrap-data/ssh_keys/zuul_gatewayserver_rsa
      register: _sfpages_private_key_secret

    - name: Update secret_sfpages.yaml
      template:
        src: "config/zuul.d/_secret_sfpages.yaml.j2"
        dest: "{{ config_clone_dir }}/zuul.d/_secret_sfpages.yaml"
  when:
    - new_config_key
    - config_key_exists

- name: Indicate config repo changed
  set_fact:
    config_repo_updated: true
  when: _config_static_files is changed or
        _config_template_files is changed or
        _config_metrics_files is changed or
        _config_dlrn_files is changed or
        new_config_key

- name: Indicated config repo didn't changed
  set_fact:
    config_repo_updated: false
  when:
    - not _config_static_files is changed
    - not _config_template_files is changed
    - not _config_metrics_files is changed
    - not _config_dlrn_files is changed
    - not new_config_key

- name: Save config key checksum
  copy:
    content: "{{ _config_repo_key.stat.checksum|default(None) }}"
    dest: /var/lib/software-factory/state/config_key_checksum
  when: config_key_exists
