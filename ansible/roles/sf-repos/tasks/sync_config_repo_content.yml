---
- stat:
    path: "{{ config_clone_dir }}/metrics"

- name: Add default metrics configuration directory
  synchronize:
    src: /usr/share/sf-config/ansible/roles/sf-repos/files/config/metrics/
    dest: "{{ config_clone_dir }}/metrics"
    archive: "no"
    times: "no"
    checksum: "yes"
    perms: "yes"
    recursive: "yes"
  register: _config_metrics_files

- name: Add default dlrn configuration directory
  synchronize:
    src: /usr/share/sf-config/ansible/roles/sf-repos/files/config/dlrn/
    dest: "{{ config_clone_dir }}/dlrn"
    archive: "no"
    times: "no"
    checksum: "yes"
    perms: "yes"
    recursive: "yes"
  register: _config_dlrn_files

- name: Ensure config sub dir
  file:
    path: "{{ config_clone_dir }}/{{ item }}"
    state: directory
  with_items:
    - nodepool
    - zuul
    - zuul.d
    - playbooks/base

- name: Ensure retro-compatibility symlinks
  file:
    src: "{{ item }}"
    dest: "{{ config_clone_dir }}/{{ item }}V3"
    state: link
  with_items:
    - nodepool
    - zuul

- name: Sync config static files
  synchronize:
    src: "/usr/share/sf-config/ansible/roles/sf-repos/files/config/{{ item }}/"
    dest: "{{ config_clone_dir }}/{{ item }}/"
    archive: "no"
    times: "no"
    checksum: "yes"
    delete: "yes"
    perms: "yes"
    recursive: "yes"
  with_items:
    - playbooks/config
    - playbooks/pages
  register: _config_static_files

- name: Update config templates
  template:
    src: "config/{{ item }}.j2"
    dest: "{{ config_clone_dir }}/{{ item }}"
  with_items:
    - playbooks/base/pre.yaml
    - playbooks/base/post.yaml
    - zuul.d/_jobs-base.yaml
    - zuul.d/_jobs-pages.yaml
    - zuul.d/_pipelines.yaml
    - zuul/_main.yaml
    - nodepool/_local_hypervisor_oci.yaml
  register: _config_template_files

- name: Check for _secret_sflogs file
  stat:
    path: "{{ config_clone_dir }}/zuul.d/_secret_sflogs.yaml"
  register: _secret_sflogs

- block:
    - name: "Generate sflogs ssh_private_key secret"
      command: >
        /usr/share/sf-config/scripts/zuul-encrypt-secret.py \
            /var/lib/software-factory/bootstrap-data/certs/config.pub ssh_private_key \
            --infile /var/lib/software-factory/bootstrap-data/ssh_keys/zuul_logserver_rsa
      register: _sflogs_private_key_secret

    - name: Update secret_sflogs.yaml
      template:
        src: "config/zuul.d/_secret_sflogs.yaml.j2"
        dest: "{{ config_clone_dir }}/zuul.d/_secret_sflogs.yaml"
  when: not _secret_sflogs.stat.exists

- name: Check for _secret_install_server file
  stat:
    path: "{{ config_clone_dir }}/zuul.d/_secret_install_server.yaml"
  register: _secret_install_server

- name: Check for misplaced config.pub
  stat:
    path: /var/lib/software-factory/certs/config.pub
  register: _config_pub

- name: Fix config.pub cert path
  command: mv /var/lib/software-factory/certs/config.pub /var/lib/software-factory/bootstrap-data/certs/config.pub
  when: _config_pub.stat.exists

- name: install server secret
  block:

    - name: "Generate install_server ssh_private_key secret"
      command: >
        /usr/share/sf-config/scripts/zuul-encrypt-secret.py \
            /var/lib/software-factory/bootstrap-data/certs/config.pub ssh_private_key \
            --infile /var/lib/software-factory/bootstrap-data/ssh_keys/zuul_worker_rsa
      register: _install_server_private_key_secret

    - name: Update secret_install_server.yaml
      template:
        src: "config/zuul.d/_secret_install_server.yaml.j2"
        dest: "{{ config_clone_dir }}/zuul.d/_secret_install_server.yaml"
  when: not _secret_install_server.stat.exists

- name: Check for _secret_pages file
  stat:
    path: "{{ config_clone_dir }}/zuul.d/_secret_sfpages.yaml"
  register: _secret_sfpages

- block:
    - name: Generate sfpages ssh_private_key secret
      command: >
        /usr/share/sf-config/scripts/zuul-encrypt-secret.py \
            /var/lib/software-factory/bootstrap-data/certs/config.pub ssh_private_key \
            --infile /var/lib/software-factory/bootstrap-data/ssh_keys/zuul_gatewayserver_rsa
      register: _sfpages_private_key_secret

    - name: Update secret_sfpages.yaml
      template:
        src: "config/zuul.d/_secret_sfpages.yaml.j2"
        dest: "{{ config_clone_dir }}/zuul.d/_secret_sfpages.yaml"
  when: not _secret_sfpages.stat.exists

- name: Indicate config repo changed
  set_fact:
    config_repo_updated: true
  when: _config_static_files is changed or
        _config_template_files is changed or
        _config_metrics_files is changed or
        _config_dlrn_files is changed or
        not _secret_sflogs.stat.exists or
        not _secret_sfpages.stat.exists or
        not _secret_install_server.stat.exists

- name: Indicated config repo didn't changed
  set_fact:
    config_repo_updated: false
  when:
    - not _config_static_files is changed
    - not _config_template_files is changed
    - not _config_metrics_files is changed
    - not _config_dlrn_files is changed
    - _secret_sflogs.stat.exists
    - _secret_sfpages.stat.exists
    - _secret_install_server.stat.exists
