- name: set status according to zuul_success
  set_fact:
    build_status: "{{ (not zuul_success|bool) | ternary('FAILURE', 'SUCCESS') }}"
  when: zuul_success is defined

- name: update mqtt_payload with status
  set_fact:
    mqtt_payload: "{{ mqtt_payload | combine({status: build_status }) }}"
  when: zuul_success is defined

- name: set default topic
  set_fact:
    mqtt_topic: "zuul/{{ zuul.tenant }}/{{ zuul.project.name }}/{{ zuul.pipeline }}/{{ zuul.job }}"
  when: mqtt_topic is not defined

- name: publish status to MQTT
  mqtt:
    topic: "{{ mqtt_topic }}"
    payload: "{{ mqtt_payload | to_json }}"
    server: "{{ mqtt_server }}"
    username: "{{ mqtt_username }}"
    password: "{{ mqtt_password }}"
