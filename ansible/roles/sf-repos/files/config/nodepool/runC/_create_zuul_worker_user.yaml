---
- name: Create sshd server keys
  command: "{{ bwrap_command }} /usr/sbin/ssh-keygen rsa"
  args:
    creates: "{{ target_dir }}/etc/ssh/ssh_host_rsa_key"

- name: Read host user id
  command: awk -F ":" '/zuul-worker/ { print $3 }' /etc/passwd
  register: _host_uid

- name: Create zuul-worker user
  command: "{{ bwrap_command }} useradd -u {{ _host_uid.stdout }} -m zuul-worker"
  args:
    creates: "{{ target_dir }}/home/zuul-worker"

- name: Create /home/zuul-worker/.ssh
  file:
    path: "{{ target_dir }}/home/zuul-worker/.ssh"
    state: directory
    mode: 0700
    owner: zuul-worker

- name: Adds ssh key
  copy:
    src: /var/lib/software-factory/bootstrap-data/ssh_keys/zuul_rsa.pub
    dest: "{{ target_dir }}/home/zuul-worker/.ssh/authorized_keys"
    owner: zuul-worker

- name: Ensure src dir exists
  file:
    path: "{{ target_dir }}/home/zuul-worker/src"
    state: directory
    owner: zuul-worker
