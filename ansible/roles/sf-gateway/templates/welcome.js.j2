// @licstart  The following is the entire license notice for the
// JavaScript code in this page.
//
// Copyright 2016 Red Hat
//
// Licensed under the Apache License, Version 2.0 (the "License"); you may
// not use this file except in compliance with the License. You may obtain
// a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
// WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
// License for the specific language governing permissions and limitations
// under the License.
//
// @licend  The above is the entire license notice
// for the JavaScript code in this page.

// Fancy tooltips
$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
});

angular.module('sfWelcome', []).controller('mainController', function($scope, $http, $location) {
    $scope.hide = true;
    $scope.dlimit = 5;
    $http.get('/manage/v2/resources').
        success(function(data) {
            $scope.Projects = data['resources']['projects'];
            $scope.p_r_infos = {};
            $scope.config_project_name = '{{ config_project_name }}';
            default_tenant_name = '{{ tenant_name }}';
            {% if 'gerrit' in roles %}
            $scope.review_service = true;
            {% else %}
            $scope.review_service = false;
            {% endif %}
            angular.forEach($scope.Projects, function(project, pname) {
                // Get project's tenant
                if (project['tenant'] == undefined) {
                    tenant_name = default_tenant_name;
                } else {
                    tenant_name = project['tenant'];
                }
                tenant = data['resources']['tenants'][tenant_name];
                if (!tenant) {
                    // fallback to default as the provided tenant name does not exist
                    tenant_name = default_tenant_name;
                    tenant = data['resources']['tenants'][tenant_name];
                }
                // Get tenant default's connection
                td_connection = data['resources']['connections'][tenant['default-connection']];
                // Get project connection
                if (project['connection'] == undefined) {
                    p_connection = td_connection;
                } else {
                    p_connection = data['resources']['connections'][project['connection']];
                }
                new_sr = [];
                $scope.p_r_infos[pname] = {}
                angular.forEach(project['source-repositories'], function(sr, key) {
                    rname = Object.keys(sr)[0]
                    if (!('private' in sr[rname] && sr[rname]['private'])) {
                        new_sr.push(rname);
                        $scope.p_r_infos[pname][rname] = {}
                        // Check related repository connection
                        if (sr[rname]['connection'] != undefined) {
                            r_cnx = data['resources']['connections'][sr[rname]['connection']];
                        } else {
                            r_cnx = p_connection;
                        }
                        $scope.p_r_infos[pname][rname]['ctype'] = r_cnx['type']
                        $scope.p_r_infos[pname][rname]['clone'] = r_cnx['base-url'] + '/' + rname;
                        if (r_cnx['type'] == 'gerrit') {
                            gitweb_url = r_cnx['base-url'] + '/gitweb?p=' + rname + '.git';
                            $scope.p_r_infos[pname][rname]['browse_files'] = gitweb_url + ';a=tree';
                            $scope.p_r_infos[pname][rname]['last_commits'] =  gitweb_url + ';a=shortlog';
                            $scope.p_r_infos[pname][rname]['reviews'] = r_cnx['base-url'] + '/#/q/status:open+project:' + rname;
                        }
                        if (r_cnx['type'] == 'github') {
                            gitweb_url = r_cnx['base-url'] + '/' + rname;
                            $scope.p_r_infos[pname][rname]['browse_files'] = gitweb_url;
                            $scope.p_r_infos[pname][rname]['last_commits'] = gitweb_url; + '/commits';
                            $scope.p_r_infos[pname][rname]['reviews'] = gitweb_url; + '/pulls';
                        }
                        if (r_cnx['type'] == 'gerrit' && r_cnx['base-url'] == 'https://review.gerrithub.io') {
                            // gerrithub does not host a gitweb but use github instead
                            gitweb_url = 'https://github.com' + '/' + rname;
                            $scope.p_r_infos[pname][rname]['browse_files'] = gitweb_url;
                            $scope.p_r_infos[pname][rname]['last_commits'] = gitweb_url + '/commits';
                            $scope.p_r_infos[pname][rname]['reviews'] = r_cnx['base-url'] + '/#/q/status:open+project:' + rname;
                        }
                    }
                })
                project['source-repositories'] = new_sr;
            })
            $scope.Repos = data['resources']['repos'];
        })
});

function isCookiesEnabled() {
    var isEnabled = (navigator.cookieEnabled) ? true : false;
    if ( typeof navigator.cookieEnabled == "undefined" && !cookieEnabled ) {
        document.cookie='test';
        isEnabled = (document.cookie.indexOf('test')!=1) ? true : false;
    }
    return isEnabled;
}

function getValueOfKey(target, key) {
    var tokens = target.split(/%3B/); // semi-colon
    for ( var i = 0; i < tokens.length; i++ ) {
        var keyvalue = tokens[i].split(/%3D/);
        if ( key.indexOf(keyvalue[0]) == 0 ) {
            return keyvalue[1];
        }
    }
    return false;
}

function displayLoggedIn(username) {
    try {
        document.getElementById("login-msg").innerHTML = "Welcome " + username;
        document.getElementById("login-msg").style.display = "block";
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("login-setting").style.display = "block";
        document.getElementById("logout-btn").style.display = "block";
    } catch (err) {
    }
}

function displaySignIn() {
    try {
        localStorage.removeItem("ls.access_token");
        localStorage.removeItem("ls.token_type");
        localStorage.removeItem("ls.id_token");
        document.getElementById("login-msg").innerText = "";
        document.getElementById("login-msg").style.display = "none";
        document.getElementById("login-btn").style.display = "block";
        document.getElementById("login-setting").style.display = "none";
        document.getElementById("logout-btn").style.display = "none";
    } catch (err) {
    }
}

function initAuth() {
        var favicon = document.createElement("link");
        favicon.setAttribute("type", "image/x-icon");
        favicon.setAttribute("href", "data:image/x-icon;base64,{{ gateway_favicon_data }}");
        favicon.setAttribute("rel", "icon");
        document.getElementsByTagName("head")[0].appendChild(favicon);
        if ( isCookiesEnabled() ) {
        var tokens = document.cookie.split(';');
        for ( var i = 0; i < tokens.length; i++ ) {
            tokens[i] = tokens[i].trim();
            if ( tokens[i].indexOf('auth_pubtkt') == 0 ) {
                var username = getValueOfKey(tokens[i].substring(12), 'uid');
                console.log(username)
                if ( username ) {
                    // cid is the cauth_id that is equal to the storyboard user id
                    var storyboard_user_id = getValueOfKey(tokens[i].substring(12), 'cid')
                    localStorage.setItem("ls.id_token", storyboard_user_id);
                    // storyboard_api is already protected by cauth, the token is the username
                    localStorage.setItem("ls.access_token", username);
                    localStorage.setItem("ls.token_type", "Bearer");
                    // store sf user info
                    localStorage.setItem("sf.username", username);
                    displayLoggedIn(username);
                    return;
                }
            }
        }
    }
    displaySignIn();
    document.getElementById("login-btn").onclick = function () {
        window.location.href = "/auth/login?back=" + encodeURIComponent(window.location.href)
    };
};

window.onload = function() {initAuth();};
