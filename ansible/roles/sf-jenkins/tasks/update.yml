---
- file:
    path: /var/lib/software-factory/state/jenkins_config
    state: touch

- name: Check local config
  command: cat /var/lib/software-factory/state/jenkins_config
  register: localconfig

- name: Check upstream config
  command: git log --oneline jobs/
  args:
    chdir: /root/config
  register: upstreamconfig

- name: Update jenkins jobs
  when: localconfig.stdout != upstreamconfig.stdout
  command: "{{ item }}"
  args:
    chdir: /root/config
  with_items:
    - rm -Rf /var/lib/jenkins/.cache/jenkins_jobs
    - jenkins-jobs -l debug --ignore-cache update --delete-old jobs/
  register: _jenkins_jobs_update
  until: _jenkins_jobs_update.rc == 0
  retries: 3
  delay: 1

- name: Write config repo sha1 matching current configuration
  copy:
    content: "{{ upstreamconfig.stdout }}"
    dest: /var/lib/software-factory/state/jenkins_config
  when: localconfig.stdout != upstreamconfig.stdout
