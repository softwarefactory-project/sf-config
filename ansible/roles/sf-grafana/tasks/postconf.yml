---
- name: Make sure config repo is cleaned
  command: "git {{ item }}"
  args:
    chdir: /root/config
  with_items:
    - fetch --all
    - reset --hard origin/master --
    - clean -f -x -d
  delegate_to: localhost

- name: Render dynamic graph
  command: >
    sf-graph-render --zuul-url http://{{ zuul_web_url }}
                    --enable-logstash "{{ 'logstash' in roles }}"
                    --config-dir /root/config
                    update-grafyaml
  register: _update_cq
  failed_when: _update_cq.rc not in [0, 4]
  changed_when: _update_cq.rc == 4
  delegate_to: localhost

- name: Push new dashboard
  command: "git {{ item }}"
  args:
    chdir: /root/config
  with_items:
    - add -A
    - commit -m "Dynamic grafyaml dashboards update"
    - push git+ssh://gerrit/config master
  delegate_to: localhost
  when: _update_cq.rc == 4
