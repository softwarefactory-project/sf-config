#!/bin/sh

RETENTION_DAYS="{{ logs_expiry }}"

# Remove sha ref
REF="/var/www/logs/[a-z0-9][a-z0-9]/$(python -c "print('[a-z0-9]' * 40)")"
if ls $REF &> /dev/null; then
    find $REF -maxdepth 0 -mindepth 0 -mtime +${RETENTION_DAYS} -type d \
         -exec rm -R {} \;
fi
# Remove patchset
PAS="/var/www/logs/[0-9]*/[0-9]*/[0-9]*"
if ls $PAS &> /dev/null; then
    find $PAS -maxdepth 0 -mindepth 0 -mtime +${RETENTION_DAYS} -type d \
         -exec rm -R {} \;
fi
# Remove periodic run
PER="$(python -c "import os,re;print(' '.join(['/var/www/logs/%s' % d for d in os.listdir('/var/www/logs') if os.path.isdir(d) and not re.match('[a-f0-9][a-f0-9]', d) and not re.match('[0-9][0-9]?', d) and d != 'classifiers']))")"
if ls $PER &> /dev/null; then
    find $PER -maxdepth 6 -mindepth 5 -regex ".+[a-z0-9]7$" -mtime +${RETENTION_DAYS} -type d \
         -exec rm -R {} \;
fi
