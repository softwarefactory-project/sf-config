---
- include_tasks: "{{ sf_tasks_dir }}/check_version.yml"
- include_tasks: "{{ sf_tasks_dir }}/create_user.yml user_name=kibana"

- name: Get kibana major version
  shell: "echo {{ _installed_version.stdout }} | grep -oE '[0-9]' | head -n 1"
  register: kibana_major_version

- include_tasks: "{{ sf_tasks_dir }}/check_version.yml force_upgrade=true"
  when: kibana_major_version.stdout | int < elk_stack_version

- name: Configure kibana
  lineinfile:
    dest: /etc/kibana/kibana.yml
    regexp: '^#?{{ item.regexp }}.*'
    line: '{{ item.line }}'
  loop:
    - regexp: 'elasticsearch.url'
      line: 'elasticsearch.url: "http://elasticsearch.{{ fqdn }}:9200"'
    - regexp: 'server.host'
      line: 'server.host: kibana.{{ fqdn }}'
    - regexp: 'server.basePath'
      line: 'server.basePath: "/analytics"'
  register: kibanaconf

- name: Restart kibana after the configuration changed
  systemd:
    name: kibana
    state: restarted
  when: kibanaconf is changed or update_fqdn

- name: Kibana service started and enabled
  systemd:
    name: kibana
    state: started
    enabled: "yes"
    daemon_reload: yes

- name: Kibana needs time to create optimized js bundles
  wait_for:
    host: 'kibana.{{ fqdn }}'
    port: 5601
    delay: 10
    timeout: 600

- name: Check if bundle js top menu patch was applied
  command: grep -q "loadTopmenu" /usr/share/kibana/optimize/bundles/kibana.bundle.js
  register: kibana_patch_bundle_js
  failed_when: kibana_patch_bundle_js.rc != 0 and kibana_patch_bundle_js.rc != 1
  changed_when: false

- name: Check if style css top menu patch_style_ was applied
  command: grep -q "loadTopmenu" /usr/share/kibana/optimize/bundles/kibana.style.css
  register: kibana_patch_style_css
  failed_when: kibana_patch_style_css.rc != 0 and kibana_patch_style_css.rc != 1
  changed_when: false

- name: Patch kibana bundle js file
  lineinfile:
    dest: /usr/share/kibana/optimize/bundles/kibana.bundle.js
    line: "{{ kibana_bundle_js_patch }}"
  when: kibana_patch_bundle_js.rc == 1

- name: Patch kibana style css file
  lineinfile:
    dest: /usr/share/kibana/optimize/bundles/kibana.style.css
    line: "{{ kibana_style_css_patch }}"
  when: kibana_patch_style_css.rc == 1
