---
- name: Wait for service
  wait_for:
    host: '{{ kibana_host }}'
    port: '{{ kibana_http_port }}'
    delay: 10
    timeout: 600

- name: Patch kibana bundle js file
  replace:
    path: "/usr/share/kibana/plugins/opendistroSecurityKibana/server/index.js"
    regexp: "If you have forgotten your username or password, please ask your system administrator"
    replace: "{{ kibana_bundle_js_patch }}"
  register: kibana_login_page

- name: Check if logstash default index pattern exists in Elasticsearch
  uri:
    url: '{{ kibana_internal_url }}/api/saved_objects/index-pattern/logstash'
    force_basic_auth: yes
    method: GET
    user: admin
    password: "{{ elasticsearch_password }}"
    status_code: 200, 404, 302
    headers:
      kbn-xsrf: true
    validate_certs: yes
  register: json_response
  no_log: true

- name: Create logstash index pattern
  block:
    - name: Create logstash default index pattern in Elasticsearch
      uri:
        url: '{{ kibana_internal_url }}/api/saved_objects/index-pattern/logstash'
        force_basic_auth: yes
        method: POST
        user: admin
        password: "{{ elasticsearch_password }}"
        body_format: json
        body: '{
                "attributes": {
                  "title": "logstash-*",
                  "timeFieldName": "@timestamp"
                }
              }'
        status_code: 200, 409
        headers:
          kbn-xsrf: true
          charset: utf-8
        validate_certs: yes
      no_log: false

    # Set the default index pattern to avoid error:
    # "Unable to update UI setting Request failed with status code: 403"
    - name: Set logstash default index pattern in Elasticsearch as default
      uri:
        url: '{{ kibana_internal_url }}/api/kibana/settings'
        force_basic_auth: yes
        method: POST
        user: admin
        password: "{{ elasticsearch_password }}"
        body_format: json
        body: '{"changes":{"defaultIndex":"logstash"}}'
        status_code: 200, 409
        headers:
          kbn-xsrf: true
        validate_certs: yes
      no_log: false

  when:
    - json_response.status == 404

- name: Restart Kibana after changing login page
  systemd:
    name: kibana
    state: restarted
  when: kibana_login_page.changed
