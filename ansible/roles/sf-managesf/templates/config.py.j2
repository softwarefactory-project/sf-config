#
# Copyright (C) 2014 eNovance SAS <licensing@enovance.com>
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
# Server Specific Configurations
import os

# Pecan Application Configurations
server = {
    'port': {{ managesf_port }},
    'host': '0.0.0.0',
}

app = {
    'guess_content_type_from_ext': False,
    'root': 'managesf.controllers.root.RootController',
    'modules': ['managesf'],
    'template_path': '%(confdir)s/managesf/templates',
    'debug': {% if managesf_loglevel == 'DEBUG' %}True{% else %}False{% endif %},
}

logging = {
    'root': {'level': '{{ managesf_root_loglevel }}', 'handlers': ['normal', 'console']},
    'loggers': {
        'managesf': {
            'level': '{{ managesf_loglevel }}',
            'handlers': ['normal', 'console'],
            'propagate': False
        },
    },
    'handlers': {
        'console': {'level': 'INFO', 'class': 'logging.StreamHandler',
                    'formatter': 'console'},
        'normal': {
            'class': 'logging.handlers.TimedRotatingFileHandler',
            'level': 'DEBUG',
            'formatter': 'normal',
            'filename': '/var/log/managesf/managesf.log',
            'when': 'D',
            'interval': 1,
            'backupCount': 30,
        },
    },
    'formatters': {
        'console': {'format': ('%(levelname)-5.5s [%(name)s]'
                               '[%(threadName)s] %(message)s')},
        'normal': {'format': ('%(asctime)s %(levelname)-5.5s [%(name)s]'
                              '[%(threadName)s] %(message)s')},
    }
}

# Authorization configurations
auth = {
    'host': '{{ cauth_host }}',
}

services = [
{% if 'storyboard' in roles %}
    'SFStoryboard',
{% endif %}
{% if 'gerrit' in roles %}
    'SFGerrit',
{% endif %}
{% if 'jenkins' in roles %}
    'SFJenkins',
{% endif %}
{% if 'nodepool' in roles %}
    'SFNodepool',
{% endif %}
]

mysql = {
    'host': '{{ managesf_mysql_host }}',
}

managesf = {
    'host': '{{ managesf_host }}',
    'sshkey_update_path': '/var/lib/managesf/.ssh/jenkins_rsa',
    'sshkey_priv_path': '/var/lib/managesf/.ssh/id_rsa',
    'backup_dir': '/var/lib/managesf/',
}

admin = {
    'name': 'admin',
    'email': 'admin@{{ fqdn }}',
    'http_password': '{{ authentication['admin_password'] }}',
}

resources = {
    'workdir': '/var/lib/managesf',
    'subdir': 'resources',
    'master_repo': '{{ gateway_url }}/r/config',
}

{% if 'gerrit' in roles %}
gerrit = {
    'url': '{{ gerrit_internal_url }}',
    'password': '{{ gerrit_admin_password }}',

    # Remove bellow configuration when api-key and user management is
    # implemented through REST api
    'user': 'gerrit',
    'admin_user': 'admin',
    'admin_password': '{{ authentication['admin_password'] }}',
    'host': '{{ gerrit_host }}',
    'top_domain': '{{ fqdn }}',
    'ssh_port': 29418,
    'sshkey_priv_path': '/var/lib/managesf/.ssh/gerrit_admin_rsa',
    'replication_config_path': '/etc/gerrit/replication.config',
    'db_host': '{{ gerrit_mysql_host }}',
    'db_name': '{{ gerrit_mysql_db }}',
    'db_user': '{{ gerrit_mysql_user }}',
    'db_password': '{{ gerrit_mysql_password }}'
}
{% endif %}

{% if 'zuul' in roles %}
zuul = {
    'api_root_url': 'http://{{ zuul_web_url }}/',
    'admin_api_root_url': 'http://{{ zuul_admin_web_url }}/',
}
{% endif %}

{% if 'nodepool' in roles %}
nodepool = {
    'api_root_url': '{{ nodepool_internal_url }}/',
    'admin_api_root_url': '{{ nodepool_admin_internal_url }}/',
}
{% endif %}

{% if 'storyboard' in roles %}
storyboard = {
    'base_url': '{{ gateway_url }}',
    'url': '{{ storyboard_internal_url }}',
    'host': 'storyboard',
    'service_token': '{{ storyboard_service_token }}',
    'db_host': '{{ storyboard_mysql_host }}',
    'db_name': '{{ storyboard_mysql_db }}',
    'db_user': '{{ storyboard_mysql_user }}',
    'db_password': '{{ storyboard_mysql_password }}',
}
{% endif %}

sqlalchemy = {
    'url': 'mysql://{{ managesf_mysql_user }}:{{ managesf_mysql_password }}@{{ managesf_mysql_host }}:{{ managesf_mysql_port }}/{{ managesf_mysql_db }}?charset=utf8',
    'encoding': 'utf-8',
}

policy = {
    'policy_file': '/etc/managesf/policy.yaml',
}

# Activate API v2 here
# list endpoints to implement, and services these endpoints must interact with

# TODO merge this with passthrough confs up there
# References to non existing zuul2 role meant to show these endpoints were zuulv2 only
api = {
    'v2': {
        'builds': [
{% if 'zuul2' in roles %}
            'SFZuul',
{% endif %}
        ],
        'jobs': [
{% if 'zuul2' in roles %}
            'SFZuul',
{% endif %}
        ],
    }
}
