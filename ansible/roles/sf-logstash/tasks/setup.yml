---
- include_tasks: "{{ sf_tasks_dir }}/check_version.yml"
- include_tasks: "{{ sf_tasks_dir }}/create_user.yml user_name=logstash"

- name: Get logstash major version
  shell: "echo _installed_version.stdout | grep -oE '[0-9]' | head -n 1"
  register: logstash_major_version

- include_tasks: "{{ sf_tasks_dir }}/check_version.yml force_upgrade=true"
  when: logstash_major_version.stdout | int < elk_stack_version

- name: Install logstash configuration
  template:
    src: templates/indexer.conf.erb
    dest: /etc/logstash/conf.d/indexer.conf
  register: config

- stat:
    path: /var/log/logstash/logstash.log
  register: logfile

- name: Create logstash.log
  file:
    path: /var/log/logstash/logstash.log
    owner: logstash
    group: logstash
  when: logfile.stat.exists

- name: Install configuration files
  template:
    src: "{{ item }}.j2"
    dest: "/etc/logstash/{{ item }}"
  register: logstash_templates
  with_items:
    - curator.yml
    - delete_old_indices.yml

- name: Configure jvm
  lineinfile:
    dest: /etc/logstash/jvm.options
    regexp: '^#?{{ item.regexp }}.*'
    line: '{{ item.line }}'
  with_items:
    - regexp: '-Xms'
      line: '-Xms{{ logstash_minimum_heap_size }}'
    - regexp: '-Xmx'
      line: '-Xmx{{ logstash_maximum_heap_size }}'
  register: logstash_config

- name: Restart logstash if needed
  service:
    name: logstash
    state: restarted
  when: logstash_config is changed or logstash_templates is changed

- name: Enable logstash
  service:
    name: logstash
    enabled: "yes"
    state: started

- name: Setup delete old logstash indexes CRON
  cron:
    name: "Delete old logstash indexes"
    minute: 0
    hour: 0
    day: '*'
    job: "/bin/curator --config /etc/logstash/curator.yml /etc/logstash/delete_old_indices.yml"
