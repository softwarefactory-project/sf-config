---
- include_tasks: "{{ sf_tasks_dir }}/check_version.yml"
- include_tasks: "{{ sf_tasks_dir }}/create_user.yml"
  vars:
    user_name: logstash

- name: Create cert dir
  file:
    path: "{{ logstash_stack_certs }}"
    owner: logstash
    group: root
    state: directory

- name: Copy CA cert to logstash dir
  copy:
    src: "/var/lib/software-factory/bootstrap-data/certs/localCA.pem"
    dest: "{{ logstash_stack_certs }}/localCA.pem"
    mode: 0600
    owner: logstash
    group: root

- stat:
    path: /var/log/logstash/logstash.log
  register: logfile

- name: Create logstash.log
  file:
    path: /var/log/logstash/logstash.log
    owner: logstash
    group: logstash
  when: logfile.stat.exists

- name: Install configuration files
  template:
    src: "{{ item.name }}.j2"
    dest: "{{ item.path | default('/etc/logstash') }}/{{ item.name }}"
  register: logstash_templates
  loop:
    - {name: 'curator.yml'}
    - {name: 'delete_old_indices.yml'}
    - {name: 'indexer.conf', path: '/etc/logstash/conf.d'}

- name: Configure jvm
  lineinfile:
    dest: /etc/logstash/jvm.options
    regexp: '^#?{{ item.regexp }}.*'
    line: '{{ item.line }}'
  loop:
    - regexp: '-Xms'
      line: '-Xms{{ logstash_minimum_heap_size }}'
    - regexp: '-Xmx'
      line: '-Xmx{{ logstash_maximum_heap_size }}'
  register: logstash_jvm_config
  when: sf_previous_version < 3.6

# NOTE(dpawik) The logstash key exists in sfconfig.yaml and new package
# is not replacing the file and the configuration on upgrade, so the
# CI tests are taking previous values, which are not enough for current
# deployment.
- name: Get values from new yaml sfconfig
  block:
    - name: Get new package sfconfig yaml file
      set_fact:
        sfconfig_yaml_new: "{{ lookup('file','/etc/software-factory/sfconfig.yaml.rpmnew') | from_yaml }}"

    - name: Configure jvm
      lineinfile:
        dest: /etc/logstash/jvm.options
        regexp: '^#?{{ item.regexp }}.*'
        line: '{{ item.line }}'
      loop:
        - regexp: '-Xms'
          line: "-Xms{{ sfconfig_yaml_new['logstash']['minimum_heap_size'] | default(logstash_minimum_heap_size) }}"
        - regexp: '-Xmx'
          line: "-Xms{{ sfconfig_yaml_new['logstash']['maximum_heap_size'] | default(logstash_maximum_heap_size) }}"
      register: logstash_jvm_config
  when:
    - sf_previous_version >= 3.6

- name: Restart logstash if needed
  service:
    name: logstash
    state: restarted
  when: logstash_jvm_config.changed or logstash_templates.changed

- name: Enable logstash
  service:
    name: logstash
    enabled: "yes"
    state: started

- name: Setup delete old logstash indexes CRON
  cron:
    name: "Delete old logstash indexes"
    minute: 0
    hour: 0
    day: '*'
    job: "/bin/curator --config /etc/logstash/curator.yml /etc/logstash/delete_old_indices.yml"
