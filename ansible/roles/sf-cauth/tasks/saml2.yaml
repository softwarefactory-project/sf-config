---
- name: Install SAML2 HTTPd configuration
  copy:
      src: "{{ item.name }}"
      dest: "{{ item.dest }}/{{ item.name }}"
  with_items:
      - {name: saml_auth.conf, dest: /etc/httpd/conf.d/}

- name: Generate SP metadata
  command: /usr/share/sf-config/scripts/generate_sp_metadata.sh "https://{{ fqdn }}/mellon/metadata" "https://{{ fqdn }}/mellon" "/etc/pki/tls/certs/{{ fqdn }}.crt"

- name: Check if mod_auth_mellon is disabled
  stat:
    path: /etc/httpd/conf.modules.d/10-auth_mellon.conf.disabled
    register: mellon_conf_disabled

- name: Check for the presence of IdP metadata
  stat:
    path: /etc/httpd/saml2/idp_metadata.xml
    register: idp_metadata

- name: Enable mod_auth_mellon if the configuration is complete
  block:
    - copy:
        remote_src: yes
        src: /etc/httpd/conf.modules.d/10-auth_mellon.conf.disabled
        dest: /etc/httpd/conf.modules.d/10-auth_mellon.conf
    - file:
        path: /etc/httpd/conf.modules.d/10-auth_mellon.conf.disabled
        state: absent
  when: not authentication.SAML2.disabled and mellon_conf_disabled.exists and idp_metadata.exists
  register: saml2_enabled
