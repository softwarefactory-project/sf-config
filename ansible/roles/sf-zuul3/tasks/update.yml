---
- file:
    path: /var/lib/software-factory/state/zuul3_config
    state: touch

- name: Check local config
  command: cat /var/lib/software-factory/state/zuul3_config
  register: localconfig

- name: Check upstream config
  command: git log -n 3 --oneline zuulV3/
  args:
    chdir: /root/config
  register: upstreamconfig

- block:
    - name: Update zuul main.yaml
      command: /usr/share/sf-config/scripts/zuul3-conf-merger.py zuulV3/ "{{ zuul3_conf_dir }}/main.yaml"
      args:
        chdir: /root/config

    - name: Reload zuul-scheduler service
      service:
        name: rh-python35-zuul-scheduler
        state: reloaded
      when: "'zuul-scheduler' in zuul3_services"
  when: localconfig.stdout != upstreamconfig.stdout

- name: Ensure service are started and enabled
  service:
    name: "rh-python35-{{ item }}"
    state: started
    enabled: yes
  with_items: "{{ zuul3_services }}"

- name: Write config repo sha1 matching current configuration
  copy:
    content: "{{ upstreamconfig.stdout }}"
    dest: /var/lib/software-factory/state/zuul3_config
  when: localconfig.stdout != upstreamconfig.stdout
