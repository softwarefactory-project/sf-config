---
- file:
    path: /var/lib/software-factory/state/zuul3_config
    state: touch

- name: Check local config
  command: cat /var/lib/software-factory/state/zuul3_config
  register: localconfig

- name: Check upstream config
  command: git log --oneline zuulV3/
  args:
    chdir: /root/config
  register: upstreamconfig

- name: Update zuul main.yaml
  command: /usr/share/sf-config/scripts/zuul3-conf-merger.py zuulV3/ "{{ zuul3_conf_dir }}/main.yaml"
  args:
    chdir: /root/config
  when: "localconfig.stdout != upstreamconfig.stdout"

# Hard restart until zuul-executor implement graceful restart
# Is it really needed?
- name: Reload zuul-executor service
  service:
    name: rh-python35-zuul-executor
    state: restarted
    enabled: "yes"
  when: "'zuul-executor' in zuul3_services and localconfig.stdout != upstreamconfig.stdout"

# Zuul-merger doesn't support reload, restart is needed
- name: Restart zuul-merger service
  service:
    name: rh-python35-zuul-merger
    state: restarted
    enabled: "yes"
  when: "'zuul-merger' in zuul3_services and localconfig.stdout != upstreamconfig.stdout"

# Zuul-web doesn't support reload, restart is needed
- name: Restart zuul-web service
  service:
    name: rh-python35-zuul-web
    state: restarted
    enabled: "yes"
  when: "'zuul-web' in zuul3_services and localconfig.stdout != upstreamconfig.stdout"

- name: Reload zuul-scheduler service
  service:
    name: rh-python35-zuul-scheduler
    state: reloaded
    enabled: "yes"
  when: "'zuul-scheduler' in zuul3_services and localconfig.stdout != upstreamconfig.stdout"

- name: Write config repo sha1 matching current configuration
  copy:
    content: "{{ upstreamconfig.stdout }}"
    dest: /var/lib/software-factory/state/zuul3_config
  when: localconfig.stdout != upstreamconfig.stdout
