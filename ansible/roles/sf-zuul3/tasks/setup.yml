---
# Use 0751 to let apache access /var/lib/zuul/git
# Use /bin/sh shell to allow zuul to connect to localhost for config-update jobs
- include: "{{ sf_tasks_dir }}/create_user.yml user_name=zuul ssh_key=zuul_rsa home_dir={{ zuul3_lib_dir }} home_dir_mode=0751 shell=/bin/sh"

- name: Apply selinux port labelling
  seport:
    ports: "{{ zuul3_port }}"
    proto: tcp
    setype: http_port_t
    state: present
  when: ansible_selinux.status == "enabled"

- name: Setup apache site zuul.conf
  template: src=zuul.site.j2 dest=/etc/httpd/conf.d/zuul3.conf mode=0444
  notify: apache reload

- name: Create /var/www/zuul3
  file: path=/var/www/zuul3 state=directory

- name: Symlink zuul image
  file: src="{{ zuul3_share_dir }}/images/" dest=/var/www/zuul3/images state=link

- name: Symlink zuul static assets
  file: src="{{ zuul3_share_dir }}/" dest=/var/www/static/zuul state=link

- name: Install index.html for zuul
  copy:
    src: zuul.index.html
    dest: /var/www/zuul3/index.html
    mode: 0444

- name: "Setup configuration"
  template: src={{ item }}.j2 dest={{ zuul3_conf_dir }}/{{ item }}
  with_items:
    - gearman-logging.conf
    - scheduler-logging.conf
    - merger-logging.conf
    - executor-logging.conf
  notify: restart zuul3 if already started

- name: "Setup sysconfig"
  template: src=sysconfig.j2 dest="{{ zuul3_sysconfig}}"
  notify: restart zuul3 if already started

- name: "Setup configuration"
  template: src=zuul.conf.j2 dest={{ zuul3_conf_dir }}/zuul.conf mode=0440 group=zuul
  notify: restart zuul3 if already started
