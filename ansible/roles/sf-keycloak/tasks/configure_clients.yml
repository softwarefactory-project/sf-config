---
- name: "Create OIDC client for component {{ item }} if needed"
  shell: /opt/jboss/keycloak/bin/kcadm.sh create clients -r {{ keycloak_default_realm }} -s clientId={{ item }} -s "enabled=true" -s clientAuthenticatorType=client-secret -s 'redirectUris=["https://{{ fqdn }}/*","https://{{ item }}.{{ fqdn }}/*"]' --no-config --server http://127.0.0.1:{{ keycloak_port }}/auth --realm master --user admin --password {{ authentication.admin_password }}
  register: _client_create
  failed_when: _client_create.rc != 0 and _client_create.stderr.find("already exists") == -1

- name: "Get {{ item }} client ID"
  block:
    - shell: /opt/jboss/keycloak/bin/kcadm.sh get clients -r {{ keycloak_default_realm }} -q clientId={{ item }} --fields id --no-config --server http://127.0.0.1:{{ keycloak_port }}/auth --realm master --user admin --password {{ authentication.admin_password }}
      register: _cid
    - set_fact:
        cid: "{{ _cid.stdout | from_json }}"

- name: "Update {{ item }} client password"
  shell: /opt/jboss/keycloak/bin/kcadm.sh update clients/{{ cid[0]['id'] }} -r {{ keycloak_default_realm }} -s secret={{ vars['keycloak_' + item + '_client_secret'] }} --no-config --server http://127.0.0.1:{{ keycloak_port }}/auth --realm master --user admin --password {{ authentication.admin_password }}
