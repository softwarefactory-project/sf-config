---
- name: Remove old configuration files
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/ssh/ssh_known_hosts
    - /etc/jenkins_jobs
    - /usr/local/bin/gearman-check
    - /var/lib/edeploy
    - /var/lib/software-factory/dashboards_config
    - /var/lib/software-factory/gerrit_config
    - /var/lib/software-factory/jenkins_config
    - /var/lib/software-factory/jenkins
    - /var/lib/software-factory/nodepool_config
    - /var/lib/software-factory/repoxplorer_config
    - /var/lib/software-factory/zuul_config

- name: Remove old crontabs
  cron:
    name: gearman-check-cron
    state: absent

- name: Remove old services
  service:
    name: "{{ item }}"
    state: stopped
    enabled: "no"
  ignore_errors: "yes"
  with_items:
    - zuul-server
    - zuul-merger
    - zuul-launcher
    - nodepool-builder
    - nodepool-launcher
    - jenkins

- name: Ensure unused repos are removed from sf-release.repo
  yum_repository:
    name: '{{ item }}'
    state: absent
    file: sf-release
  notify: yum-clean-metadata
  with_items:
    - openstack-pike
    - centos-release-ceph-jewel
    - centos-opstools

- name: Copy sf-release.repo
  copy:
    remote_src: yes
    src: /etc/yum.repos.d/sf-release.repo
    dest: /etc/yum.repos.d/sf-release.repo.bck

- name: Remove old repos
  yum:
    name: '{{ item }}'
    state: absent
  with_items:
    - centos-release-ceph-jewel
    - centos-release-openstack-pike
    - centos-release-opstools
  when: ansible_distribution == "CentOS"

- name: Restore sf-release.repo
  copy:
    remote_src: yes
    src: /etc/yum.repos.d/sf-release.repo.bck
    dest: /etc/yum.repos.d/sf-release.repo

- name: Ensure yum clean metadata is applied
  meta: flush_handlers
