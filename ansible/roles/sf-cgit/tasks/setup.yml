---
- include_tasks: "{{ sf_tasks_dir }}/check_version.yml"

- name: Configure cgitrc
  lineinfile:
    dest: /etc/cgitrc
    regexp: "^{{ item.key }}=.*"
    line: "{{ item.key }}={{ item.value }}"
  with_items:
    - {key: "clone-prefix", value: "{{ gateway_url }}/cgit"}
    - {key: "head-include", value: "/var/www/static/index-header.html"}
    - {key: "include", value: "/etc/cgitrepos"}
    - {key: "logo", value: ""}

- name: Add smart http git transport
  copy:
    content: |
      SetEnv GIT_PROJECT_ROOT /var/lib/software-factory/git/
      <Directory /usr/libexec/git-core>
        Require all granted
      </Directory>
      SetEnv GIT_HTTP_EXPORT_ALL
      ScriptAliasMatch "^/cgit/(.*/(HEAD|info/refs))$" /usr/libexec/git-core/git-http-backend/$1
      ScriptAliasMatch "^/cgit/(.*/git-(upload|receive)-pack)$" /usr/libexec/git-core/git-http-backend/$1
    dest: /etc/httpd/conf.d/cgit-smart-http.conf

- name: Setup cgit config generator
  template:
    src: cgit-config-generator.py.j2
    dest: /usr/local/bin/cgit-config-generator.py
    mode: 0755

- name: Check if repo are already configured
  stat:
    path: /etc/cgitrepos
  register: _cgit_config

- name: Install a default configuration for internal repos
  copy:
    content: |
      repo.url=config
      repo.path=/var/lib/software-factory/git/config.git
      repo.url=sf-jobs
      repo.path=/var/lib/software-factory/git/sf-jobs.git
      repo.url=zuul-jobs
      repo.path=/var/lib/software-factory/git/zuul-jobs.git
    dest: /etc/cgitrepos
  when: not _cgit_config.stat.exists
